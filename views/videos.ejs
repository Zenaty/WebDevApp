<!DOCTYPE html>
<html>
  <head>
    <title>YouTube Search & Favorites</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/">SQLWeb</a>

        <div class="ms-auto d-flex align-items-center gap-2">
          <span class="navbar-text text-white-50">
            <%= user.fullName %> (<%= user.email %>)
          </span>
          <form method="POST" action="/logout" class="m-0">
            <button class="btn btn-outline-light btn-sm" type="submit">
              Logout
            </button>
          </form>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <h1 class="h3 mb-3">YouTube Search</h1>

      <form method="GET" action="/videos" class="row g-2 align-items-center">
        <div class="col-12 col-md-9">
          <input
            class="form-control"
            name="q"
            value="<%= q %>"
            placeholder="Search on YouTube..."
            required
          />
        </div>
        <div class="col-12 col-md-3 d-grid">
          <button class="btn btn-primary" type="submit">Search</button>
        </div>
      </form>

      <% if (error) { %>
      <div class="alert alert-danger mt-3"><%= error %></div>
      <% } %>

      <% if (results && results.length) { %>
      <div class="mt-4">
        <h2 class="h5 mb-3">Results</h2>
        <div class="row g-3">
          <% results.forEach((v) => { %>
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm">
              <% if (v.thumbnailUrl) { %>
              <img
                src="<%= v.thumbnailUrl %>"
                class="card-img-top"
                alt="thumbnail"
              />
              <% } %>

              <div class="card-body d-flex flex-column">
                <h3 class="h6 card-title"><%= v.title %></h3>
                <p class="card-text text-muted mb-3">
                  <%= v.channelTitle || "" %>
                </p>

                <div class="mt-auto d-grid gap-2">
                  <a
                    class="btn btn-outline-secondary btn-sm"
                    target="_blank"
                    rel="noreferrer"
                    href="https://www.youtube.com/watch?v=<%= v.videoId %>"
                  >
                    Open
                  </a>

                  <!-- ADD TO FAVORITES (AJAX, NO REFRESH) -->
                  <form
                    method="POST"
                    action="/videos/favorites"
                    class="add-to-favorites"
                    data-video-id="<%= v.videoId %>"
                    data-title="<%- (v.title || '').replace(/"/g, '&quot;') %>"
                    data-channel-title="<%- (v.channelTitle || '').replace(/"/g, '&quot;') %>"
                    data-thumbnail-url="<%= v.thumbnailUrl || '' %>"
                  >
                    <button class="btn btn-success btn-sm" type="submit">
                      Save to favorites
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <% }) %>
        </div>
      </div>
      <% } %>

      <hr class="my-5" />

      <h2 class="h5 mb-3">My Favorites</h2>

      <div id="favoritesSection">
        <% if (!favorites || favorites.length === 0) { %>
        <div class="alert alert-info">
          No favorites yet. Search and add some.
        </div>
        <% } else { %>
        <div class="list-group shadow-sm" id="favoritesList">
          <% favorites.forEach((f) => { %>
          <div class="list-group-item" data-favorite-row="<%= f.id %>">
            <div class="d-flex gap-3">
              <% if (f.thumbnailUrl) { %>
              <img
                src="<%= f.thumbnailUrl %>"
                alt="thumb"
                style="width: 120px; height: auto; border-radius: 6px"
              />
              <% } %>

              <div class="flex-grow-1">
                <div class="fw-semibold"><%= f.title %></div>
                <div class="text-muted small mb-2">
                  <%= f.channelTitle || "" %>
                </div>

                <div class="d-flex gap-2">
                  <a
                    class="btn btn-outline-secondary btn-sm"
                    target="_blank"
                    rel="noreferrer"
                    href="https://www.youtube.com/watch?v=<%= f.videoId %>"
                  >
                    Open
                  </a>

                  <!-- DELETE (AJAX, NO REFRESH) -->
                  <form
                    method="POST"
                    action="/videos/favorites/<%= f.id %>/delete"
                    class="delete-favorite m-0"
                    data-favorite-id="<%= f.id %>"
                  >
                    <button class="btn btn-danger btn-sm" type="submit">
                      Delete
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <% }) %>
        </div>
        <% } %>
      </div>
    </main>

    <!-- TOAST -->
    <div
    id="favToast"
    style="
        position: fixed;
        top: 30px;
        right: 30px;
        background: #198754;
        color: white;
        padding: 22px 28px;
        border-radius: 14px;
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.35);
        font-size: 1.25rem;
        font-weight: 600;
        display: none;
        z-index: 9999;
        max-width: 420px;
    "
    >
        הודעה   
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    function showToast(msg, ok = true) {
        const toast = document.getElementById("favToast");
        toast.textContent = msg;
        toast.style.background = ok ? "#198754" : "#dc3545";
        toast.style.display = "block";
        toast.style.opacity = "0";
        toast.style.transform = "translateY(-10px)";

        setTimeout(() => {
            toast.style.transition = "all 0.2s ease-out";
            toast.style.opacity = "1";
            toast.style.transform = "translateY(0)";
        }, 10);

        setTimeout(() => {
            toast.style.opacity = "0";
            toast.style.transform = "translateY(-10px)";
        }, 1600);

        setTimeout(() => {
            toast.style.display = "none";
            toast.style.transition = "none";
        }, 1900);
    }


      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, (m) => ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        }[m]));
      }

      function renderFavorites(favorites) {
        const section = document.getElementById("favoritesSection");

        if (!favorites || favorites.length === 0) {
          section.innerHTML = `
            <div class="alert alert-info">
              No favorites yet. Search and add some.
            </div>
          `;
          return;
        }

        const rows = favorites.map((f) => `
          <div class="list-group-item" data-favorite-row="${f.id}">
            <div class="d-flex gap-3">
              ${f.thumbnailUrl ? `
                <img src="${escapeHtml(f.thumbnailUrl)}" alt="thumb"
                  style="width: 120px; height: auto; border-radius: 6px" />
              ` : ""}

              <div class="flex-grow-1">
                <div class="fw-semibold">${escapeHtml(f.title)}</div>
                <div class="text-muted small mb-2">${escapeHtml(f.channelTitle || "")}</div>

                <div class="d-flex gap-2">
                  <a class="btn btn-outline-secondary btn-sm" target="_blank" rel="noreferrer"
                     href="https://www.youtube.com/watch?v=${encodeURIComponent(f.videoId)}">
                    Open
                  </a>

                  <form method="POST"
                        action="/videos/favorites/${encodeURIComponent(f.id)}/delete"
                        class="delete-favorite m-0"
                        data-favorite-id="${f.id}">
                    <button class="btn btn-danger btn-sm" type="submit">Delete</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        `).join("");

        section.innerHTML = `
          <div class="list-group shadow-sm" id="favoritesList">
            ${rows}
          </div>
        `;

        attachDeleteHandlers();
      }

      async function fetchFavorites() {
        const res = await fetch("/videos/favorites/json", {
          headers: { "Accept": "application/json" },
        });
        if (!res.ok) throw new Error("Failed to load favorites");
        return res.json();
      }

      async function addFavoriteAjax({ videoId, title, channelTitle, thumbnailUrl }) {
        const body = new URLSearchParams({
          videoId,
          title,
          channelTitle,
          thumbnailUrl,
        });

        const res = await fetch("/videos/favorites", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "Accept": "application/json",
          },
          body,
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || "Add failed");
        }
        return res.json();
      }

      async function deleteFavoriteAjax(favoriteId) {
        const res = await fetch(`/videos/favorites/${encodeURIComponent(favoriteId)}/delete`, {
          method: "POST",
          headers: { "Accept": "application/json" },
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || "Delete failed");
        }
        return res.json();
      }

      function attachAddHandlers() {
        document.querySelectorAll("form.add-to-favorites").forEach((form) => {
          form.addEventListener("submit", async (e) => {
            e.preventDefault(); // <-- מונע ריפרש

            const payload = {
              videoId: form.dataset.videoId,
              title: form.dataset.title || "",
              channelTitle: form.dataset.channelTitle || "",
              thumbnailUrl: form.dataset.thumbnailUrl || "",
            };

            try {
              await addFavoriteAjax(payload);
              showToast("הסרטון התווסף למועדפים ✅", true);

              const data = await fetchFavorites();
              renderFavorites(data.favorites);
            } catch (err) {
              showToast("שגיאה בהוספה ❌", false);
              console.log(err);
            }
          });
        });
      }

      function attachDeleteHandlers() {
        document.querySelectorAll("form.delete-favorite").forEach((form) => {
          form.addEventListener("submit", async (e) => {
            e.preventDefault(); // <-- מונע ריפרש

            const favoriteId = form.dataset.favoriteId;
            try {
              await deleteFavoriteAjax(favoriteId);
              showToast("נמחק מהמועדפים ✅", true);

              const data = await fetchFavorites();
              renderFavorites(data.favorites);
            } catch (err) {
              showToast("שגיאה במחיקה ❌", false);
              console.log(err);
            }
          });
        });
      }

      // init
      attachAddHandlers();
      attachDeleteHandlers();
    </script>
  </body>
</html>
